<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文康活動報到工具 (連線同步版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-checked-in { background-color: #dcfce7; color: #166534; border-left: 4px solid #22c55e; }
        .status-pending { background-color: #f3f4f6; border-left: 4px solid #9ca3af; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .toast.show { opacity: 1; visibility: visible; }
        #confirmation-bar { display: none; padding: 12px; background-color: #2563eb; color: white; text-align: center; position: sticky; top: 0; z-index: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .connection-indicator { position: fixed; top: 10px; right: 10px; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 1000; }
        .connected { background-color: #22c55e; color: white; }
        .disconnected { background-color: #ef4444; color: white; }
        .connecting { background-color: #f59e0b; color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .pulse-animation { animation: pulse 1s infinite; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="connection-status" class="connection-indicator connecting">連線中...</div>

    <div id="confirmation-bar">
        <span id="confirmation-text"></span>
        <button id="close-confirmation-bar" class="ml-4 font-bold">關閉</button>
    </div>

    <div class="container mx-auto p-4 md:p-6 max-w-4xl">
        <header class="text-center mb-6 fade-in">
            <h1 class="text-3xl font-bold text-gray-900">公司文康活動報到系統 <span class="text-lg text-blue-600">(連線版)</span></h1>
            <p class="text-lg text-gray-600 mt-1">旭集餐廳 | 9月22日 (週一) 11:30 集合</p>
            <p class="text-sm text-blue-500 mt-2">
                <span id="online-users">線上人數: 載入中...</span> | 
                即時同步資料
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-md fade-in" style="animation-delay: 0.1s;">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">即時統計</h2>
                    <div id="stats-container" class="space-y-3 text-gray-700"></div>
                    <button id="confirm-restaurant-btn" class="w-full mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">與餐廳核對人數</button>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-md fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">餐廳識別圖</h2>
                    <div id="image-preview-container" class="hidden mb-4 border-2 border-dashed rounded-lg p-2"><img id="image-preview" src="#" alt="識別圖預覽" class="max-w-full h-auto rounded-md mx-auto"></div>
                    <p id="image-placeholder" class="text-center text-gray-500 mb-4">尚未上傳圖片</p>
                    <input type="file" id="image-uploader" class="hidden" accept="image/*">
                    <button id="upload-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 mb-2">上傳/更換圖片</button>
                    <p class="text-xs text-center text-gray-500">圖片將同步到所有裝置</p>
                </div>
            </div>
            <div class="lg:col-span-2 bg-white p-4 sm:p-6 rounded-2xl shadow-md fade-in" style="animation-delay: 0.3s;">
                <h2 class="text-xl font-semibold mb-4 flex justify-between items-center">
                    <span>參加人員名單</span>
                    <button id="reset-btn" class="text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md">重設所有資料</button>
                </h2>
                <div id="attendee-list" class="space-y-3"></div>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="toast"></div>

    <script>
        class EventCheckinSystem {
            constructor() {
                this.socket = null;
                this.attendees = [];
                this.imageUrl = null;
                this.isConnected = false;
                this.init();
            }

            init() {
                this.initElements();
                this.connectSocket();
                this.bindEvents();
            }

            initElements() {
                this.attendeeListContainer = document.getElementById('attendee-list');
                this.statsContainer = document.getElementById('stats-container');
                this.confirmRestaurantBtn = document.getElementById('confirm-restaurant-btn');
                this.uploadBtn = document.getElementById('upload-btn');
                this.imageUploader = document.getElementById('image-uploader');
                this.imagePreview = document.getElementById('image-preview');
                this.imagePreviewContainer = document.getElementById('image-preview-container');
                this.imagePlaceholder = document.getElementById('image-placeholder');
                this.toast = document.getElementById('toast-notification');
                this.confirmationBar = document.getElementById('confirmation-bar');
                this.confirmationText = document.getElementById('confirmation-text');
                this.closeConfirmationBarBtn = document.getElementById('close-confirmation-bar');
                this.resetBtn = document.getElementById('reset-btn');
                this.connectionStatus = document.getElementById('connection-status');
                this.onlineUsers = document.getElementById('online-users');
            }

            connectSocket() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    this.isConnected = true;
                    this.updateConnectionStatus();
                    this.showToast('已連接到伺服器', false);
                });

                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.updateConnectionStatus();
                    this.showToast('與伺服器斷線', true);
                });

                this.socket.on('initialData', (data) => {
                    this.attendees = data.attendees;
                    this.render();
                });

                this.socket.on('attendeeUpdated', (attendee) => {
                    const index = this.attendees.findIndex(a => a.id === attendee.id);
                    if (index !== -1) {
                        this.attendees[index] = attendee;
                        this.render();
                        this.showToast(`${attendee.name} 的狀態已更新`);
                    }
                });

                this.socket.on('imageUpdated', (data) => {
                    this.imageUrl = data.imageUrl;
                    this.updateImageDisplay();
                    this.showToast('識別圖已更新');
                });

                this.socket.on('dataReset', (data) => {
                    this.attendees = data.attendees;
                    this.imageUrl = null;
                    this.render();
                    this.showToast('所有資料已重設');
                });

                this.socket.on('userCountUpdate', (count) => {
                    this.onlineUsers.textContent = `線上人數: ${count}`;
                });

                this.socket.on('connect_error', (error) => {
                    console.error('Socket connection error:', error);
                    this.updateConnectionStatus();
                });
            }

            updateConnectionStatus() {
                if (this.isConnected) {
                    this.connectionStatus.className = 'connection-indicator connected';
                    this.connectionStatus.textContent = '已連線';
                } else {
                    this.connectionStatus.className = 'connection-indicator disconnected pulse-animation';
                    this.connectionStatus.textContent = '離線';
                }
            }

            bindEvents() {
                this.attendeeListContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('check-in-btn')) {
                        const id = parseInt(e.target.dataset.id);
                        this.toggleCheckin(id);
                    }
                });

                this.attendeeListContainer.addEventListener('change', (e) => {
                    if (e.target.classList.contains('car-plate-input')) {
                        const id = parseInt(e.target.dataset.id);
                        const carPlate = e.target.value.trim().toUpperCase();
                        this.updateCarPlate(id, carPlate);
                    }
                });

                this.uploadBtn.addEventListener('click', () => this.imageUploader.click());
                
                this.imageUploader.addEventListener('change', (e) => {
                    this.handleImageUpload(e);
                });

                this.confirmRestaurantBtn.addEventListener('click', () => {
                    this.showRestaurantConfirmation();
                });

                this.closeConfirmationBarBtn.addEventListener('click', () => {
                    this.confirmationBar.style.display = 'none';
                });

                this.resetBtn.addEventListener('click', () => {
                    this.resetAllData();
                });
            }

            async toggleCheckin(id) {
                const attendee = this.attendees.find(a => a.id === id);
                if (!attendee) return;

                const newStatus = attendee.status === 'pending' ? 'checked-in' : 'pending';
                
                try {
                    const response = await fetch(`/api/attendees/${id}/checkin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (!response.ok) {
                        throw new Error('更新失敗');
                    }
                } catch (error) {
                    this.showToast('更新失敗: ' + error.message, true);
                }
            }

            async updateCarPlate(id, carPlate) {
                try {
                    const response = await fetch(`/api/attendees/${id}/carplate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ carPlate })
                    });

                    if (!response.ok) {
                        throw new Error('更新車號失敗');
                    }
                } catch (error) {
                    this.showToast('更新車號失敗: ' + error.message, true);
                }
            }

            async handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    this.showToast('圖片檔案過大，請選擇5MB以下的圖片', true);
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (re) => {
                    try {
                        const response = await fetch('/api/image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ imageData: re.target.result })
                        });

                        if (!response.ok) {
                            throw new Error('上傳圖片失敗');
                        }
                    } catch (error) {
                        this.showToast('上傳圖片失敗: ' + error.message, true);
                    }
                };
                reader.readAsDataURL(file);
            }

            showRestaurantConfirmation() {
                const checkedInPeople = this.attendees.filter(p => p.status === 'checked-in').reduce((sum, p) => sum + p.total, 0);
                this.confirmationText.textContent = `你好，目前已報到 ${checkedInPeople} 位，請協助確認，謝謝！`;
                this.confirmationBar.style.display = 'block';
            }

            async resetAllData() {
                if (!confirm('您確定要重設所有報到狀態、車號和圖片嗎？此操作無法復原。')) {
                    return;
                }

                try {
                    const response = await fetch('/api/reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) {
                        throw new Error('重設失敗');
                    }
                } catch (error) {
                    this.showToast('重設失敗: ' + error.message, true);
                }
            }

            render() {
                this.renderAttendees();
                this.updateStats();
                this.updateImageDisplay();
            }

            renderAttendees() {
                this.attendeeListContainer.innerHTML = '';
                this.attendees.forEach(p => {
                    const isCheckedIn = p.status === 'checked-in';
                    const cardClass = isCheckedIn ? 'status-checked-in' : 'status-pending';
                    let nameDisplay = p.name;
                    if (p.isLeader) nameDisplay += ' (領隊)';
                    let details = `(共 ${p.total} 位)`;
                    if (p.dependents > 0) details = `(${p.relation} ${p.dependents} 位，共 ${p.total} 位)`;
                    else if (p.relation !== '本人') details = `(${p.relation}，共 ${p.total} 位)`;
                    
                    const personCardHTML = `
                        <div class="p-4 rounded-xl transition-all duration-300 ${cardClass}">
                            <div class="flex flex-wrap items-center justify-between gap-4">
                                <div class="flex-grow">
                                    <p class="font-bold text-lg">${nameDisplay} <span class="text-sm font-normal text-gray-600">${details}</span></p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <label for="car-${p.id}" class="text-sm font-medium">車號:</label>
                                        <input type="text" id="car-${p.id}" value="${p.carPlate || ''}" placeholder="無或尚未提供" data-id="${p.id}" class="car-plate-input w-36 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    <button class="check-in-btn ${isCheckedIn ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white font-bold py-2 px-4 rounded-lg" data-id="${p.id}">${isCheckedIn ? '取消報到' : '確認報到'}</button>
                                </div>
                            </div>
                        </div>`;
                    this.attendeeListContainer.insertAdjacentHTML('beforeend', personCardHTML);
                });
            }

            updateStats() {
                const totalPeople = this.attendees.reduce((sum, p) => sum + p.total, 0);
                const checkedInPeople = this.attendees.filter(p => p.status === 'checked-in').reduce((sum, p) => sum + p.total, 0);
                this.statsContainer.innerHTML = `
                    <p>總計人數：<span class="font-bold text-xl text-blue-600">${totalPeople}</span> 位</p>
                    <p>已報到人數：<span class="font-bold text-xl text-green-600">${checkedInPeople}</span> 位</p>
                    <p>未報到人數：<span class="font-bold text-xl text-red-600">${totalPeople - checkedInPeople}</span> 位</p>
                    <p>已登記車輛：<span class="font-bold text-xl text-indigo-600">${this.attendees.filter(p => p.carPlate && p.carPlate.trim()).length}</span> 輛</p>`;
            }

            updateImageDisplay() {
                if (this.imageUrl) {
                    this.imagePreview.src = this.imageUrl;
                    this.imagePreviewContainer.classList.remove('hidden');
                    this.imagePlaceholder.classList.add('hidden');
                } else {
                    this.imagePreviewContainer.classList.add('hidden');
                    this.imagePlaceholder.classList.remove('hidden');
                }
            }

            showToast(message, isError = false) {
                this.toast.textContent = message;
                this.toast.className = 'toast show';
                this.toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
                setTimeout(() => { this.toast.className = 'toast'; }, 3000);
            }
        }

        // 啟動系統
        document.addEventListener('DOMContentLoaded', () => {
            new EventCheckinSystem();
        });
    </script>
</body>
</html>