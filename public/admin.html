<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-checked-in { background-color: #dcfce7; color: #166534; border-left: 4px solid #22c55e; }
        .status-pending { background-color: #f3f4f6; border-left: 4px solid #9ca3af; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .toast.show { opacity: 1; visibility: visible; }
        .connection-indicator { position: fixed; top: 10px; right: 10px; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 1000; }
        .connected { background-color: #22c55e; color: white; }
        .disconnected { background-color: #ef4444; color: white; }
        .connecting { background-color: #f59e0b; color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .pulse-animation { animation: pulse 1s infinite; }
        .event-card { transition: all 0.3s ease; }
        .event-card:hover { transform: translateY(-2px); }
        .active-event { border: 3px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="connection-status" class="connection-indicator connecting">é€£ç·šä¸­...</div>

    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
        <div class="text-center mb-2">
            <a href="/login.html" class="text-blue-600 hover:text-blue-800 text-sm">â† è¿”å›ç™»å…¥</a>
        </div>

        <header class="text-center mb-8 fade-in">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">æ´»å‹•ç®¡ç†å¾Œå°</h1>
            <p class="text-lg text-gray-600">ç®¡ç†å“¡å°ˆç”¨ - å…¨éƒ¨æ´»å‹•ç¸½è¦½</p>
        </header>

        <!-- æ´»å‹•é¸æ“‡ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 fade-in" style="animation-delay: 0.1s;">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“… é¸æ“‡æ´»å‹•</h2>
            <div id="events-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- ç•¶å‰æ´»å‹•è©³æƒ… -->
        <div id="current-event-section" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <!-- çµ±è¨ˆè³‡æ–™ -->
                    <div class="bg-white p-6 rounded-2xl shadow-md fade-in" style="animation-delay: 0.2s;">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2">ğŸ“Š å³æ™‚çµ±è¨ˆ</h2>
                        <div id="stats-container" class="space-y-3 text-gray-700"></div>
                        <button id="confirm-restaurant-btn" class="w-full mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">èˆ‡é¤å»³æ ¸å°äººæ•¸</button>
                    </div>
                    
                    <!-- åœ–ç‰‡ç®¡ç† -->
                    <div class="bg-white p-6 rounded-2xl shadow-md fade-in" style="animation-delay: 0.3s;">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2">ğŸ“ é›†åˆåœ°é»åœ–ç‰‡</h2>
                        <div id="image-preview-container" class="hidden mb-4 border-2 border-dashed rounded-lg p-2">
                            <img id="image-preview" src="#" alt="é›†åˆåœ°é»åœ–ç‰‡" class="max-w-full h-auto rounded-md mx-auto">
                        </div>
                        <p id="image-placeholder" class="text-center text-gray-500 mb-4">å°šæœªä¸Šå‚³åœ–ç‰‡</p>
                        <input type="file" id="image-uploader" class="hidden" accept="image/*">
                        <button id="upload-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 mb-2">ä¸Šå‚³/æ›´æ›åœ–ç‰‡</button>
                        <p class="text-xs text-center text-gray-500">åœ–ç‰‡å°‡åŒæ­¥åˆ°æ‰€æœ‰è£ç½®</p>
                    </div>
                </div>
                
                <!-- åƒåŠ è€…åå–® -->
                <div class="lg:col-span-2 bg-white p-4 sm:p-6 rounded-2xl shadow-md fade-in" style="animation-delay: 0.4s;">
                    <h2 class="text-xl font-semibold mb-4 flex justify-between items-center">
                        <span id="attendees-title">åƒåŠ äººå“¡åå–®</span>
                        <div class="flex space-x-2">
                            <span id="online-users" class="text-sm text-blue-600 mr-4">ç·šä¸Šäººæ•¸: è¼‰å…¥ä¸­...</span>
                            <button id="reset-btn" class="text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md">é‡è¨­æ‰€æœ‰è³‡æ–™</button>
                        </div>
                    </h2>
                    <div id="attendee-list" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¢ºèªå°è©±æ¡† -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 m-4 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-900 mb-4">èˆ‡é¤å»³æ ¸å°äººæ•¸</h3>
            <div id="confirmation-content" class="text-gray-700 mb-6"></div>
            <div class="flex space-x-4">
                <button id="copy-message-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">è¤‡è£½è¨Šæ¯</button>
                <button id="close-modal-btn" class="flex-1 bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script>
        class AdminSystem {
            constructor() {
                this.socket = null;
                this.events = [];
                this.currentEventId = null;
                this.attendees = [];
                this.isConnected = false;
                this.init();
            }

            init() {
                this.initElements();
                this.connectSocket();
                this.loadEvents();
                this.bindEvents();
            }

            initElements() {
                this.eventsList = document.getElementById('events-list');
                this.currentEventSection = document.getElementById('current-event-section');
                this.attendeeList = document.getElementById('attendee-list');
                this.statsContainer = document.getElementById('stats-container');
                this.attendeesTitle = document.getElementById('attendees-title');
                this.confirmRestaurantBtn = document.getElementById('confirm-restaurant-btn');
                this.uploadBtn = document.getElementById('upload-btn');
                this.imageUploader = document.getElementById('image-uploader');
                this.imagePreview = document.getElementById('image-preview');
                this.imagePreviewContainer = document.getElementById('image-preview-container');
                this.imagePlaceholder = document.getElementById('image-placeholder');
                this.resetBtn = document.getElementById('reset-btn');
                this.toast = document.getElementById('toast-notification');
                this.connectionStatus = document.getElementById('connection-status');
                this.onlineUsers = document.getElementById('online-users');
                this.confirmationModal = document.getElementById('confirmation-modal');
                this.confirmationContent = document.getElementById('confirmation-content');
                this.copyMessageBtn = document.getElementById('copy-message-btn');
                this.closeModalBtn = document.getElementById('close-modal-btn');
            }

            connectSocket() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    this.isConnected = true;
                    this.updateConnectionStatus();
                    this.showToast('å·²é€£æ¥åˆ°ä¼ºæœå™¨', false);
                });

                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.updateConnectionStatus();
                    this.showToast('èˆ‡ä¼ºæœå™¨æ–·ç·š', true);
                });

                this.socket.on('attendeeUpdated', (attendee) => {
                    if (attendee.event_id == this.currentEventId) {
                        const index = this.attendees.findIndex(a => a.id === attendee.id);
                        if (index !== -1) {
                            this.attendees[index] = attendee;
                            this.renderAttendees();
                            this.loadStats();
                        }
                    }
                });

                this.socket.on('imageUpdated', (data) => {
                    this.updateImageDisplay(data.imageUrl);
                    this.showToast('é›†åˆåœ°é»åœ–ç‰‡å·²æ›´æ–°');
                });

                this.socket.on('dataReset', (data) => {
                    if (this.currentEventId) {
                        this.attendees = data.attendees;
                        this.renderAttendees();
                        this.loadStats();
                        this.showToast('æ´»å‹•è³‡æ–™å·²é‡è¨­');
                    }
                });

                this.socket.on('eventUserCountUpdate', (count) => {
                    this.onlineUsers.textContent = `æœ¬æ´»å‹•ç·šä¸Šäººæ•¸: ${count}`;
                });
            }

            bindEvents() {
                this.confirmRestaurantBtn.addEventListener('click', () => {
                    this.showRestaurantConfirmation();
                });

                this.uploadBtn.addEventListener('click', () => {
                    this.imageUploader.click();
                });

                this.imageUploader.addEventListener('change', (e) => {
                    this.handleImageUpload(e);
                });

                this.resetBtn.addEventListener('click', () => {
                    this.resetEventData();
                });

                this.copyMessageBtn.addEventListener('click', () => {
                    this.copyConfirmationMessage();
                });

                this.closeModalBtn.addEventListener('click', () => {
                    this.closeModal();
                });

                this.attendeeList.addEventListener('click', (e) => {
                    if (e.target.classList.contains('check-in-btn')) {
                        const id = parseInt(e.target.dataset.id);
                        this.toggleCheckin(id);
                    }
                });

                this.attendeeList.addEventListener('change', (e) => {
                    if (e.target.classList.contains('car-plate-input')) {
                        const id = parseInt(e.target.dataset.id);
                        const carPlate = e.target.value.trim().toUpperCase();
                        this.updateCarPlate(id, carPlate);
                    }
                });
            }

            async loadEvents() {
                try {
                    const response = await fetch('/api/events');
                    if (!response.ok) throw new Error('è¼‰å…¥æ´»å‹•å¤±æ•—');
                    
                    this.events = await response.json();
                    this.renderEvents();
                } catch (error) {
                    this.showToast('è¼‰å…¥æ´»å‹•æ¸…å–®å¤±æ•—: ' + error.message, true);
                }
            }

            renderEvents() {
                this.eventsList.innerHTML = '';
                
                this.events.forEach(event => {
                    const eventCard = document.createElement('div');
                    eventCard.className = `event-card bg-white border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-blue-300 hover:shadow-lg ${this.currentEventId == event.id ? 'active-event' : ''}`;
                    eventCard.innerHTML = `
                        <h3 class="font-bold text-lg text-gray-900 mb-2">${event.name}</h3>
                        <p class="text-gray-600 text-sm mb-1">ğŸ“… ${event.date} ${event.time || ''}</p>
                        <p class="text-gray-600 text-sm">ğŸ“ ${event.location || ''}</p>
                        <div class="mt-3 text-xs text-blue-600 font-semibold">
                            ${this.currentEventId == event.id ? 'ğŸ‘ˆ ç›®å‰é¸ä¸­' : 'é»æ“Šç®¡ç†'}
                        </div>
                    `;
                    
                    eventCard.addEventListener('click', () => {
                        this.selectEvent(event.id, event.name);
                    });
                    
                    this.eventsList.appendChild(eventCard);
                });
            }

            selectEvent(eventId, eventName) {
                if (this.currentEventId) {
                    this.socket.emit('leaveEvent', this.currentEventId);
                }
                
                this.currentEventId = eventId;
                this.attendeesTitle.textContent = `åƒåŠ äººå“¡åå–® - ${eventName}`;
                this.socket.emit('joinEvent', eventId);
                
                this.renderEvents(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºé¸ä¸­ç‹€æ…‹
                this.currentEventSection.classList.remove('hidden');
                this.loadEventData();
            }

            async loadEventData() {
                try {
                    await Promise.all([
                        this.loadAttendees(),
                        this.loadStats(),
                        this.loadImage()
                    ]);
                } catch (error) {
                    this.showToast('è¼‰å…¥æ´»å‹•è³‡æ–™å¤±æ•—: ' + error.message, true);
                }
            }

            async loadAttendees() {
                const response = await fetch(`/api/events/${this.currentEventId}/attendees`);
                if (!response.ok) throw new Error('è¼‰å…¥åƒåŠ è€…å¤±æ•—');
                
                this.attendees = await response.json();
                this.renderAttendees();
            }

            async loadStats() {
                const response = await fetch(`/api/events/${this.currentEventId}/stats`);
                if (!response.ok) throw new Error('è¼‰å…¥çµ±è¨ˆå¤±æ•—');
                
                const stats = await response.json();
                this.statsContainer.innerHTML = `
                    <p>ç¸½è¨ˆäººæ•¸ï¼š<span class="font-bold text-xl text-blue-600">${stats.totalPeople}</span> ä½</p>
                    <p>å·²å ±åˆ°äººæ•¸ï¼š<span class="font-bold text-xl text-green-600">${stats.checkedInPeople}</span> ä½</p>
                    <p>æœªå ±åˆ°äººæ•¸ï¼š<span class="font-bold text-xl text-red-600">${stats.pendingPeople}</span> ä½</p>
                    <p>å·²ç™»è¨˜è»Šè¼›ï¼š<span class="font-bold text-xl text-indigo-600">${stats.carsRegistered}</span> è¼›</p>
                `;
            }

            async loadImage() {
                const response = await fetch(`/api/events/${this.currentEventId}/image`);
                if (!response.ok) return;
                
                const data = await response.json();
                this.updateImageDisplay(data.imageUrl);
            }

            renderAttendees() {
                this.attendeeList.innerHTML = '';
                
                this.attendees.forEach(p => {
                    const isCheckedIn = p.status === 'checked-in';
                    const cardClass = isCheckedIn ? 'status-checked-in' : 'status-pending';
                    let nameDisplay = p.name;
                    if (p.isLeader) nameDisplay += ' (é ˜éšŠ)';
                    
                    let details = `(å…± ${p.total} ä½)`;
                    if (p.dependents > 0) {
                        details = `(${p.relation} ${p.dependents} ä½ï¼Œå…± ${p.total} ä½)`;
                    } else if (p.relation !== 'æœ¬äºº') {
                        details = `(${p.relation}ï¼Œå…± ${p.total} ä½)`;
                    }
                    
                    const personCardHTML = `
                        <div class="p-4 rounded-xl transition-all duration-300 ${cardClass}">
                            <div class="flex flex-wrap items-center justify-between gap-4">
                                <div class="flex-grow">
                                    <p class="font-bold text-lg">${nameDisplay} <span class="text-sm font-normal text-gray-600">${details}</span></p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <label for="car-${p.id}" class="text-sm font-medium">è»Šè™Ÿ:</label>
                                        <input type="text" id="car-${p.id}" value="${p.carPlate || ''}" placeholder="ç„¡æˆ–å°šæœªæä¾›" data-id="${p.id}" class="car-plate-input w-36 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    <button class="check-in-btn ${isCheckedIn ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white font-bold py-2 px-4 rounded-lg" data-id="${p.id}">${isCheckedIn ? 'å–æ¶ˆå ±åˆ°' : 'ç¢ºèªå ±åˆ°'}</button>
                                </div>
                            </div>
                        </div>
                    `;
                    this.attendeeList.insertAdjacentHTML('beforeend', personCardHTML);
                });
            }

            async toggleCheckin(id) {
                const attendee = this.attendees.find(a => a.id === id);
                if (!attendee) return;

                const newStatus = attendee.status === 'pending' ? 'checked-in' : 'pending';
                
                try {
                    const response = await fetch(`/api/attendees/${id}/checkin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (!response.ok) {
                        throw new Error('æ›´æ–°å¤±æ•—');
                    }
                } catch (error) {
                    this.showToast('æ›´æ–°å¤±æ•—: ' + error.message, true);
                }
            }

            async updateCarPlate(id, carPlate) {
                try {
                    const response = await fetch(`/api/attendees/${id}/carplate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ carPlate })
                    });

                    if (!response.ok) {
                        throw new Error('æ›´æ–°è»Šè™Ÿå¤±æ•—');
                    }
                } catch (error) {
                    this.showToast('æ›´æ–°è»Šè™Ÿå¤±æ•—: ' + error.message, true);
                }
            }

            async handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    this.showToast('åœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹é¸æ“‡5MBä»¥ä¸‹çš„åœ–ç‰‡', true);
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (re) => {
                    try {
                        const response = await fetch(`/api/events/${this.currentEventId}/image`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ imageData: re.target.result })
                        });

                        if (!response.ok) {
                            throw new Error('ä¸Šå‚³åœ–ç‰‡å¤±æ•—');
                        }
                    } catch (error) {
                        this.showToast('ä¸Šå‚³åœ–ç‰‡å¤±æ•—: ' + error.message, true);
                    }
                };
                reader.readAsDataURL(file);
            }

            async resetEventData() {
                if (!confirm('æ‚¨ç¢ºå®šè¦é‡è¨­æ­¤æ´»å‹•çš„æ‰€æœ‰å ±åˆ°ç‹€æ…‹ã€è»Šè™Ÿå’Œåœ–ç‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/events/${this.currentEventId}/reset`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) {
                        throw new Error('é‡è¨­å¤±æ•—');
                    }
                } catch (error) {
                    this.showToast('é‡è¨­å¤±æ•—: ' + error.message, true);
                }
            }

            showRestaurantConfirmation() {
                const checkedInPeople = this.attendees.filter(p => p.status === 'checked-in').reduce((sum, p) => sum + p.total, 0);
                const totalPeople = this.attendees.reduce((sum, p) => sum + p.total, 0);
                
                const message = `ä½ å¥½ï¼Œç›®å‰å·²å ±åˆ° ${checkedInPeople} ä½ï¼Œç¸½è¨ˆ ${totalPeople} ä½ï¼Œè«‹å”åŠ©ç¢ºèªï¼Œè¬è¬ï¼`;
                
                this.confirmationContent.innerHTML = `
                    <p class="text-lg mb-4">${message}</p>
                    <div class="bg-gray-100 p-3 rounded-lg text-sm">
                        <p><strong>è©³ç´°è³‡è¨Šï¼š</strong></p>
                        <p>å·²å ±åˆ°ï¼š${checkedInPeople} ä½</p>
                        <p>æœªå ±åˆ°ï¼š${totalPeople - checkedInPeople} ä½</p>
                        <p>ç¸½è¨ˆï¼š${totalPeople} ä½</p>
                    </div>
                `;
                
                this.currentConfirmationMessage = message;
                this.confirmationModal.classList.remove('hidden');
            }

            copyConfirmationMessage() {
                if (this.currentConfirmationMessage) {
                    navigator.clipboard.writeText(this.currentConfirmationMessage).then(() => {
                        this.showToast('è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                    }).catch(() => {
                        this.showToast('è¤‡è£½å¤±æ•—', true);
                    });
                }
            }

            closeModal() {
                this.confirmationModal.classList.add('hidden');
            }

            updateImageDisplay(imageUrl) {
                if (imageUrl) {
                    this.imagePreview.src = imageUrl;
                    this.imagePreviewContainer.classList.remove('hidden');
                    this.imagePlaceholder.classList.add('hidden');
                } else {
                    this.imagePreviewContainer.classList.add('hidden');
                    this.imagePlaceholder.classList.remove('hidden');
                }
            }

            updateConnectionStatus() {
                if (this.isConnected) {
                    this.connectionStatus.className = 'connection-indicator connected';
                    this.connectionStatus.textContent = 'å·²é€£ç·š';
                } else {
                    this.connectionStatus.className = 'connection-indicator disconnected pulse-animation';
                    this.connectionStatus.textContent = 'é›¢ç·š';
                }
            }

            showToast(message, isError = false) {
                this.toast.textContent = message;
                this.toast.className = 'toast show';
                this.toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
                setTimeout(() => {
                    this.toast.className = 'toast';
                }, 3000);
            }
        }

        // å•Ÿå‹•ç³»çµ±
        document.addEventListener('DOMContentLoaded', () => {
            new AdminSystem();
        });
    </script>
</body>
</html>