<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人報到頁面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-checked-in { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; border-left: 6px solid #22c55e; }
        .status-pending { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-left: 6px solid #9ca3af; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .toast.show { opacity: 1; visibility: visible; }
        .connection-indicator { position: fixed; top: 10px; right: 10px; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 1000; }
        .connected { background-color: #22c55e; color: white; }
        .disconnected { background-color: #ef4444; color: white; }
        .connecting { background-color: #f59e0b; color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .pulse-animation { animation: pulse 1s infinite; }
        .stats-card { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

    <div id="connection-status" class="connection-indicator connecting">連線中...</div>
    
    <div class="container mx-auto p-4 md:p-6 max-w-4xl">
        <div class="text-center mb-2">
            <a href="/login.html" class="text-blue-600 hover:text-blue-800 text-sm">← 返回登入</a>
        </div>

        <header class="text-center mb-8 fade-in">
            <div id="event-info" class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">載入中...</h1>
                <p class="text-lg text-gray-600">請稍候</p>
            </div>
            <p class="text-sm text-blue-600">
                <span id="online-users">線上人數: 載入中...</span>
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 個人報到卡片 -->
            <div class="bg-white rounded-2xl shadow-xl p-6 fade-in" style="animation-delay: 0.1s;">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">我的報到狀態</h2>
                <div id="personal-card" class="space-y-6"></div>
            </div>

            <!-- 活動統計 -->
            <div class="space-y-6">
                <div class="stats-card rounded-2xl shadow-xl p-6 fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-xl font-semibold mb-4">📊 活動統計</h2>
                    <div id="stats-container" class="space-y-3"></div>
                </div>

                <!-- 識別圖片 -->
                <div class="bg-white rounded-2xl shadow-xl p-6 fade-in" style="animation-delay: 0.3s;">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">📍 集合地點</h2>
                    <div id="image-preview-container" class="hidden mb-4">
                        <img id="image-preview" src="#" alt="集合地點圖片" class="w-full h-auto rounded-lg shadow-md">
                    </div>
                    <p id="image-placeholder" class="text-center text-gray-500 py-8 bg-gray-50 rounded-lg">
                        尚未上傳集合地點圖片
                    </p>
                </div>
            </div>
        </div>

        <!-- 注意事項 -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mt-6 fade-in" style="animation-delay: 0.4s;">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">📌 使用說明</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">✅ 報到功能</h3>
                    <p>點擊「確認報到」按鈕完成報到，可隨時取消或重新報到</p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">🚗 車號登記</h3>
                    <p>填寫您的車牌號碼，方便活動統計和安排</p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">📊 即時統計</h3>
                    <p>所有操作都會即時同步，您能看到最新的活動統計</p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">📱 多裝置同步</h3>
                    <p>在其他裝置登入也能看到您的最新報到狀態</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="toast"></div>

    <script>
        class PersonalCheckinSystem {
            constructor() {
                this.socket = null;
                this.eventId = null;
                this.attendeeId = null;
                this.attendeeData = null;
                this.isConnected = false;
                this.init();
            }

            init() {
                this.getUrlParams();
                this.initElements();
                this.connectSocket();
                this.loadPersonalData();
            }

            getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                this.eventId = params.get('event');
                this.attendeeId = params.get('attendee');
                
                if (!this.eventId || !this.attendeeId) {
                    this.showToast('參數錯誤，請重新登入', true);
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                }
            }

            initElements() {
                this.personalCard = document.getElementById('personal-card');
                this.statsContainer = document.getElementById('stats-container');
                this.eventInfo = document.getElementById('event-info');
                this.imagePreview = document.getElementById('image-preview');
                this.imagePreviewContainer = document.getElementById('image-preview-container');
                this.imagePlaceholder = document.getElementById('image-placeholder');
                this.toast = document.getElementById('toast-notification');
                this.connectionStatus = document.getElementById('connection-status');
                this.onlineUsers = document.getElementById('online-users');
            }

            connectSocket() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    this.isConnected = true;
                    this.updateConnectionStatus();
                    this.socket.emit('joinEvent', this.eventId);
                    this.showToast('已連接到伺服器', false);
                });

                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.updateConnectionStatus();
                    this.showToast('與伺服器斷線', true);
                });

                this.socket.on('attendeeUpdated', (attendee) => {
                    if (attendee.id == this.attendeeId) {
                        this.attendeeData = attendee;
                        this.renderPersonalCard();
                        this.showToast('狀態已更新');
                    }
                    this.loadStats();
                });

                this.socket.on('imageUpdated', (data) => {
                    this.updateImageDisplay(data.imageUrl);
                    this.showToast('集合地點圖片已更新');
                });

                this.socket.on('eventUserCountUpdate', (count) => {
                    this.onlineUsers.textContent = `本活動線上人數: ${count}`;
                });

                this.socket.on('connect_error', (error) => {
                    console.error('Socket connection error:', error);
                    this.updateConnectionStatus();
                });
            }

            async loadPersonalData() {
                try {
                    const response = await fetch(`/api/attendees/${this.attendeeId}`);
                    if (!response.ok) throw new Error('載入失敗');
                    
                    this.attendeeData = await response.json();
                    this.renderEventInfo();
                    this.renderPersonalCard();
                    this.loadStats();
                    this.loadImage();
                } catch (error) {
                    this.showToast('載入個人資料失敗: ' + error.message, true);
                }
            }

            renderEventInfo() {
                if (!this.attendeeData) return;
                
                this.eventInfo.innerHTML = `
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">${this.attendeeData.event_name}</h1>
                    <p class="text-lg text-gray-600">${this.attendeeData.location || ''} | ${this.attendeeData.date} ${this.attendeeData.time || ''}</p>
                `;
            }

            renderPersonalCard() {
                if (!this.attendeeData) return;

                const isCheckedIn = this.attendeeData.status === 'checked-in';
                const cardClass = isCheckedIn ? 'status-checked-in' : 'status-pending';
                
                let details = `共 ${this.attendeeData.total} 位`;
                if (this.attendeeData.dependents > 0) {
                    details = `${this.attendeeData.relation} ${this.attendeeData.dependents} 位，${details}`;
                } else if (this.attendeeData.relation !== '本人') {
                    details = `${this.attendeeData.relation}，${details}`;
                }

                this.personalCard.innerHTML = `
                    <div class="p-6 rounded-xl transition-all duration-300 ${cardClass}">
                        <div class="text-center mb-6">
                            <h3 class="text-2xl font-bold">${this.attendeeData.name} ${this.attendeeData.isLeader ? '(領隊)' : ''}</h3>
                            <p class="text-sm opacity-80">${details}</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="text-center">
                                <div class="text-4xl mb-2">${isCheckedIn ? '✅' : '⏳'}</div>
                                <div class="text-lg font-semibold">${isCheckedIn ? '已報到' : '未報到'}</div>
                                <button 
                                    id="check-in-btn" 
                                    class="${isCheckedIn ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors w-full mt-4"
                                >
                                    ${isCheckedIn ? '取消報到' : '確認報到'}
                                </button>
                            </div>
                            
                            <div class="border-t pt-4">
                                <label class="block text-sm font-medium mb-2">我的車號</label>
                                <input 
                                    type="text" 
                                    id="car-plate-input" 
                                    value="${this.attendeeData.carPlate || ''}" 
                                    placeholder="請輸入車號（如：ABC-1234）"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                >
                                <p class="text-xs text-gray-500 mt-1">輸入後自動儲存</p>
                            </div>
                        </div>
                    </div>
                `;

                this.bindPersonalCardEvents();
            }

            bindPersonalCardEvents() {
                const checkInBtn = document.getElementById('check-in-btn');
                const carPlateInput = document.getElementById('car-plate-input');

                if (checkInBtn) {
                    checkInBtn.addEventListener('click', () => {
                        this.toggleCheckin();
                    });
                }

                if (carPlateInput) {
                    let timeout;
                    carPlateInput.addEventListener('input', () => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            this.updateCarPlate(carPlateInput.value.trim().toUpperCase());
                        }, 1000);
                    });
                }
            }

            async toggleCheckin() {
                if (!this.attendeeData) return;

                const newStatus = this.attendeeData.status === 'pending' ? 'checked-in' : 'pending';
                
                try {
                    const response = await fetch(`/api/attendees/${this.attendeeId}/checkin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (!response.ok) {
                        throw new Error('更新失敗');
                    }
                } catch (error) {
                    this.showToast('報到狀態更新失敗: ' + error.message, true);
                }
            }

            async updateCarPlate(carPlate) {
                try {
                    const response = await fetch(`/api/attendees/${this.attendeeId}/carplate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ carPlate })
                    });

                    if (!response.ok) {
                        throw new Error('更新車號失敗');
                    }
                } catch (error) {
                    this.showToast('更新車號失敗: ' + error.message, true);
                }
            }

            async loadStats() {
                try {
                    const response = await fetch(`/api/events/${this.eventId}/stats`);
                    if (!response.ok) throw new Error('載入統計失敗');
                    
                    const stats = await response.json();
                    
                    this.statsContainer.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span>總計人數</span>
                            <span class="text-2xl font-bold">${stats.totalPeople}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>已報到</span>
                            <span class="text-2xl font-bold text-green-300">${stats.checkedInPeople}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>未報到</span>
                            <span class="text-2xl font-bold text-yellow-300">${stats.pendingPeople}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>已登記車輛</span>
                            <span class="text-2xl font-bold text-blue-300">${stats.carsRegistered}</span>
                        </div>
                    `;
                } catch (error) {
                    console.error('載入統計失敗:', error);
                }
            }

            async loadImage() {
                try {
                    const response = await fetch(`/api/events/${this.eventId}/image`);
                    if (!response.ok) return;
                    
                    const data = await response.json();
                    if (data.imageUrl) {
                        this.updateImageDisplay(data.imageUrl);
                    }
                } catch (error) {
                    console.error('載入圖片失敗:', error);
                }
            }

            updateImageDisplay(imageUrl) {
                if (imageUrl) {
                    this.imagePreview.src = imageUrl;
                    this.imagePreviewContainer.classList.remove('hidden');
                    this.imagePlaceholder.classList.add('hidden');
                } else {
                    this.imagePreviewContainer.classList.add('hidden');
                    this.imagePlaceholder.classList.remove('hidden');
                }
            }

            updateConnectionStatus() {
                if (this.isConnected) {
                    this.connectionStatus.className = 'connection-indicator connected';
                    this.connectionStatus.textContent = '已連線';
                } else {
                    this.connectionStatus.className = 'connection-indicator disconnected pulse-animation';
                    this.connectionStatus.textContent = '離線';
                }
            }

            showToast(message, isError = false) {
                this.toast.textContent = message;
                this.toast.className = 'toast show';
                this.toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
                setTimeout(() => {
                    this.toast.className = 'toast';
                }, 3000);
            }
        }

        // 啟動系統
        document.addEventListener('DOMContentLoaded', () => {
            new PersonalCheckinSystem();
        });
    </script>
</body>
</html>