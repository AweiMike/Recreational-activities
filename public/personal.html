<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººå ±åˆ°é é¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-checked-in { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; border-left: 6px solid #22c55e; }
        .status-pending { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-left: 6px solid #9ca3af; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .toast.show { opacity: 1; visibility: visible; }
        .connection-indicator { position: fixed; top: 10px; right: 10px; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 1000; }
        .connected { background-color: #22c55e; color: white; }
        .disconnected { background-color: #ef4444; color: white; }
        .connecting { background-color: #f59e0b; color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .pulse-animation { animation: pulse 1s infinite; }
        .stats-card { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

    <div id="connection-status" class="connection-indicator connecting">é€£ç·šä¸­...</div>
    
    <div class="container mx-auto p-4 md:p-6 max-w-4xl">
        <div class="text-center mb-2">
            <a href="/login.html" class="text-blue-600 hover:text-blue-800 text-sm">â† è¿”å›ç™»å…¥</a>
        </div>

        <header class="text-center mb-8 fade-in">
            <div id="event-info" class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">è¼‰å…¥ä¸­...</h1>
                <p class="text-lg text-gray-600">è«‹ç¨å€™</p>
            </div>
            <p class="text-sm text-blue-600">
                <span id="online-users">ç·šä¸Šäººæ•¸: è¼‰å…¥ä¸­...</span>
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- å€‹äººå ±åˆ°å¡ç‰‡ -->
            <div class="bg-white rounded-2xl shadow-xl p-6 fade-in" style="animation-delay: 0.1s;">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">æˆ‘çš„å ±åˆ°ç‹€æ…‹</h2>
                <div id="personal-card" class="space-y-6"></div>
            </div>

            <!-- æ´»å‹•çµ±è¨ˆ -->
            <div class="space-y-6">
                <div class="stats-card rounded-2xl shadow-xl p-6 fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-xl font-semibold mb-4">ğŸ“Š æ´»å‹•çµ±è¨ˆ</h2>
                    <div id="stats-container" class="space-y-3"></div>
                </div>

                <!-- è­˜åˆ¥åœ–ç‰‡ -->
                <div class="bg-white rounded-2xl shadow-xl p-6 fade-in" style="animation-delay: 0.3s;">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ“ é›†åˆåœ°é»</h2>
                    <div id="image-preview-container" class="hidden mb-4">
                        <img id="image-preview" src="#" alt="é›†åˆåœ°é»åœ–ç‰‡" class="w-full h-auto rounded-lg shadow-md">
                    </div>
                    <p id="image-placeholder" class="text-center text-gray-500 py-8 bg-gray-50 rounded-lg">
                        å°šæœªä¸Šå‚³é›†åˆåœ°é»åœ–ç‰‡
                    </p>
                </div>
            </div>
        </div>

        <!-- æ³¨æ„äº‹é … -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mt-6 fade-in" style="animation-delay: 0.4s;">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ“Œ ä½¿ç”¨èªªæ˜</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">âœ… å ±åˆ°åŠŸèƒ½</h3>
                    <p>é»æ“Šã€Œç¢ºèªå ±åˆ°ã€æŒ‰éˆ•å®Œæˆå ±åˆ°ï¼Œå¯éš¨æ™‚å–æ¶ˆæˆ–é‡æ–°å ±åˆ°</p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">ğŸš— è»Šè™Ÿç™»è¨˜</h3>
                    <p>å¡«å¯«æ‚¨çš„è»Šç‰Œè™Ÿç¢¼ï¼Œæ–¹ä¾¿æ´»å‹•çµ±è¨ˆå’Œå®‰æ’</p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">ğŸ“Š å³æ™‚çµ±è¨ˆ</h3>
                    <p>æ‰€æœ‰æ“ä½œéƒ½æœƒå³æ™‚åŒæ­¥ï¼Œæ‚¨èƒ½çœ‹åˆ°æœ€æ–°çš„æ´»å‹•çµ±è¨ˆ</p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">ğŸ“± å¤šè£ç½®åŒæ­¥</h3>
                    <p>åœ¨å…¶ä»–è£ç½®ç™»å…¥ä¹Ÿèƒ½çœ‹åˆ°æ‚¨çš„æœ€æ–°å ±åˆ°ç‹€æ…‹</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="toast"></div>

    <script>
        class PersonalCheckinSystem {
            constructor() {
                this.socket = null;
                this.eventId = null;
                this.attendeeId = null;
                this.attendeeData = null;
                this.isConnected = false;
                this.init();
            }

            init() {
                this.getUrlParams();
                this.initElements();
                this.connectSocket();
                this.loadPersonalData();
            }

            getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                this.eventId = params.get('event');
                this.attendeeId = params.get('attendee');
                
                if (!this.eventId || !this.attendeeId) {
                    this.showToast('åƒæ•¸éŒ¯èª¤ï¼Œè«‹é‡æ–°ç™»å…¥', true);
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                }
            }

            initElements() {
                this.personalCard = document.getElementById('personal-card');
                this.statsContainer = document.getElementById('stats-container');
                this.eventInfo = document.getElementById('event-info');
                this.imagePreview = document.getElementById('image-preview');
                this.imagePreviewContainer = document.getElementById('image-preview-container');
                this.imagePlaceholder = document.getElementById('image-placeholder');
                this.toast = document.getElementById('toast-notification');
                this.connectionStatus = document.getElementById('connection-status');
                this.onlineUsers = document.getElementById('online-users');
            }

            connectSocket() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    this.isConnected = true;
                    this.updateConnectionStatus();
                    this.socket.emit('joinEvent', this.eventId);
                    this.showToast('å·²é€£æ¥åˆ°ä¼ºæœå™¨', false);
                });

                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.updateConnectionStatus();
                    this.showToast('èˆ‡ä¼ºæœå™¨æ–·ç·š', true);
                });

                this.socket.on('attendeeUpdated', (attendee) => {
                    if (attendee.id == this.attendeeId) {
                        this.attendeeData = attendee;
                        this.renderPersonalCard();
                        this.showToast('ç‹€æ…‹å·²æ›´æ–°');
                    }
                    this.loadStats();
                });

                this.socket.on('imageUpdated', (data) => {
                    this.updateImageDisplay(data.imageUrl);
                    this.showToast('é›†åˆåœ°é»åœ–ç‰‡å·²æ›´æ–°');
                });

                this.socket.on('eventUserCountUpdate', (count) => {
                    this.onlineUsers.textContent = `æœ¬æ´»å‹•ç·šä¸Šäººæ•¸: ${count}`;
                });

                this.socket.on('connect_error', (error) => {
                    console.error('Socket connection error:', error);
                    this.updateConnectionStatus();
                });
            }

            async loadPersonalData() {
                try {
                    const response = await fetch(`/api/attendees/${this.attendeeId}`);
                    if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');
                    
                    this.attendeeData = await response.json();
                    this.renderEventInfo();
                    this.renderPersonalCard();
                    this.loadStats();
                    this.loadImage();
                } catch (error) {
                    this.showToast('è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—: ' + error.message, true);
                }
            }

            renderEventInfo() {
                if (!this.attendeeData) return;
                
                this.eventInfo.innerHTML = `
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">${this.attendeeData.event_name}</h1>
                    <p class="text-lg text-gray-600">${this.attendeeData.location || ''} | ${this.attendeeData.date} ${this.attendeeData.time || ''}</p>
                `;
            }

            renderPersonalCard() {
                if (!this.attendeeData) return;

                const isCheckedIn = this.attendeeData.status === 'checked-in';
                const cardClass = isCheckedIn ? 'status-checked-in' : 'status-pending';
                
                let details = `å…± ${this.attendeeData.total} ä½`;
                if (this.attendeeData.dependents > 0) {
                    details = `${this.attendeeData.relation} ${this.attendeeData.dependents} ä½ï¼Œ${details}`;
                } else if (this.attendeeData.relation !== 'æœ¬äºº') {
                    details = `${this.attendeeData.relation}ï¼Œ${details}`;
                }

                this.personalCard.innerHTML = `
                    <div class="p-6 rounded-xl transition-all duration-300 ${cardClass}">
                        <div class="text-center mb-6">
                            <h3 class="text-2xl font-bold">${this.attendeeData.name} ${this.attendeeData.isLeader ? '(é ˜éšŠ)' : ''}</h3>
                            <p class="text-sm opacity-80">${details}</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="text-center">
                                <div class="text-4xl mb-2">${isCheckedIn ? 'âœ…' : 'â³'}</div>
                                <div class="text-lg font-semibold">${isCheckedIn ? 'å·²å ±åˆ°' : 'æœªå ±åˆ°'}</div>
                                <button 
                                    id="check-in-btn" 
                                    class="${isCheckedIn ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors w-full mt-4"
                                >
                                    ${isCheckedIn ? 'å–æ¶ˆå ±åˆ°' : 'ç¢ºèªå ±åˆ°'}
                                </button>
                            </div>
                            
                            <div class="border-t pt-4">
                                <label class="block text-sm font-medium mb-2">æˆ‘çš„è»Šè™Ÿ</label>
                                <input 
                                    type="text" 
                                    id="car-plate-input" 
                                    value="${this.attendeeData.carPlate || ''}" 
                                    placeholder="è«‹è¼¸å…¥è»Šè™Ÿï¼ˆå¦‚ï¼šABC-1234ï¼‰"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                >
                                <p class="text-xs text-gray-500 mt-1">è¼¸å…¥å¾Œè‡ªå‹•å„²å­˜</p>
                            </div>
                        </div>
                    </div>
                `;

                this.bindPersonalCardEvents();
            }

            bindPersonalCardEvents() {
                const checkInBtn = document.getElementById('check-in-btn');
                const carPlateInput = document.getElementById('car-plate-input');

                if (checkInBtn) {
                    checkInBtn.addEventListener('click', () => {
                        this.toggleCheckin();
                    });
                }

                if (carPlateInput) {
                    let timeout;
                    carPlateInput.addEventListener('input', () => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            this.updateCarPlate(carPlateInput.value.trim().toUpperCase());
                        }, 1000);
                    });
                }
            }

            async toggleCheckin() {
                if (!this.attendeeData) return;

                const newStatus = this.attendeeData.status === 'pending' ? 'checked-in' : 'pending';
                
                try {
                    const response = await fetch(`/api/attendees/${this.attendeeId}/checkin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (!response.ok) {
                        throw new Error('æ›´æ–°å¤±æ•—');
                    }
                } catch (error) {
                    this.showToast('å ±åˆ°ç‹€æ…‹æ›´æ–°å¤±æ•—: ' + error.message, true);
                }
            }

            async updateCarPlate(carPlate) {
                try {
                    const response = await fetch(`/api/attendees/${this.attendeeId}/carplate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ carPlate })
                    });

                    if (!response.ok) {
                        throw new Error('æ›´æ–°è»Šè™Ÿå¤±æ•—');
                    }
                } catch (error) {
                    this.showToast('æ›´æ–°è»Šè™Ÿå¤±æ•—: ' + error.message, true);
                }
            }

            async loadStats() {
                try {
                    const response = await fetch(`/api/events/${this.eventId}/stats`);
                    if (!response.ok) throw new Error('è¼‰å…¥çµ±è¨ˆå¤±æ•—');
                    
                    const stats = await response.json();
                    
                    this.statsContainer.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span>ç¸½è¨ˆäººæ•¸</span>
                            <span class="text-2xl font-bold">${stats.totalPeople}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>å·²å ±åˆ°</span>
                            <span class="text-2xl font-bold text-green-300">${stats.checkedInPeople}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>æœªå ±åˆ°</span>
                            <span class="text-2xl font-bold text-yellow-300">${stats.pendingPeople}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>å·²ç™»è¨˜è»Šè¼›</span>
                            <span class="text-2xl font-bold text-blue-300">${stats.carsRegistered}</span>
                        </div>
                    `;
                } catch (error) {
                    console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
                }
            }

            async loadImage() {
                try {
                    const response = await fetch(`/api/events/${this.eventId}/image`);
                    if (!response.ok) return;
                    
                    const data = await response.json();
                    if (data.imageUrl) {
                        this.updateImageDisplay(data.imageUrl);
                    }
                } catch (error) {
                    console.error('è¼‰å…¥åœ–ç‰‡å¤±æ•—:', error);
                }
            }

            updateImageDisplay(imageUrl) {
                if (imageUrl) {
                    this.imagePreview.src = imageUrl;
                    this.imagePreviewContainer.classList.remove('hidden');
                    this.imagePlaceholder.classList.add('hidden');
                } else {
                    this.imagePreviewContainer.classList.add('hidden');
                    this.imagePlaceholder.classList.remove('hidden');
                }
            }

            updateConnectionStatus() {
                if (this.isConnected) {
                    this.connectionStatus.className = 'connection-indicator connected';
                    this.connectionStatus.textContent = 'å·²é€£ç·š';
                } else {
                    this.connectionStatus.className = 'connection-indicator disconnected pulse-animation';
                    this.connectionStatus.textContent = 'é›¢ç·š';
                }
            }

            showToast(message, isError = false) {
                this.toast.textContent = message;
                this.toast.className = 'toast show';
                this.toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
                setTimeout(() => {
                    this.toast.className = 'toast';
                }, 3000);
            }
        }

        // å•Ÿå‹•ç³»çµ±
        document.addEventListener('DOMContentLoaded', () => {
            new PersonalCheckinSystem();
        });
    </script>
</body>
</html>